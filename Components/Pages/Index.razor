@page "/"
@namespace InMaPro_cse325.Components.Pages

@using InMaPro_cse325.Models
@using Microsoft.EntityFrameworkCore
@inject AppDbContext Context

<PageTitle>Dashboard</PageTitle>

<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="bi bi-speedometer2 me-2"></i>Dashboard
        </h1>
        <div class="d-flex">
            <div class="dropdown me-2">
                <button class="btn btn-outline-primary dropdown-toggle" type="button" 
                        data-bs-toggle="dropdown">
                    <i class="bi bi-calendar me-1"></i>Últimos 30 días
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" @onclick='() => SetDateRange("today")'>Hoy</a></li>
                    <li><a class="dropdown-item" href="#" @onclick='() => SetDateRange("week")'>Última semana</a></li>
                    <li><a class="dropdown-item active" href="#" @onclick='() => SetDateRange("month")'>Últimos 30 días</a></li>
                    <li><a class="dropdown-item" href="#" @onclick='() => SetDateRange("thisMonth")'>Este mes</a></li>
                    <li><a class="dropdown-item" href="#" @onclick='() => SetDateRange("year")'>Este año</a></li>
                </ul>
            </div>
            <a href="/inventory/create" class="btn btn-primary">
                <i class="bi bi-plus-circle me-1"></i>Nuevo Producto
            </a>
        </div>
    </div>

    @if (loading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-3 text-muted">Cargando dashboard...</p>
        </div>
    }
    else
    {
        <!-- Row de Stats Cards -->
        <div class="row">
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-primary shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs fw-bold text-primary text-uppercase mb-1">
                                    Total de Unidades
                                </div>
                                <div class="h5 mb-0 fw-bold text-gray-800">
                                    @stats.TotalItems
                                </div>
                                <div class="mt-2 mb-0 text-muted text-xs">
                                    <span class="text-success me-2">
                                        <i class="bi bi-arrow-up"></i> 12%
                                    </span>
                                    <span>Desde el mes pasado</span>
                                </div>
                            </div>
                            <div class="col-auto">
                                <i class="bi bi-box-seam fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-success shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs fw-bold text-success text-uppercase mb-1">
                                    Valor Total
                                </div>
                                <div class="h5 mb-0 fw-bold text-gray-800">
                                    @stats.TotalValue.ToString("C")
                                </div>
                                <div class="mt-2 mb-0 text-muted text-xs">
                                    <span class="text-success me-2">
                                        <i class="bi bi-arrow-up"></i> 8.5%
                                    </span>
                                    <span>Desde el mes pasado</span>
                                </div>
                            </div>
                            <div class="col-auto">
                                <i class="bi bi-currency-dollar fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-warning shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs fw-bold text-warning text-uppercase mb-1">
                                    Bajo Stock
                                </div>
                                <div class="h5 mb-0 fw-bold text-gray-800">
                                    @stats.LowStockItems
                                </div>
                                <div class="mt-2 mb-0 text-muted text-xs">
                                    <span class="text-danger me-2">
                                        <i class="bi bi-arrow-down"></i> @GetCriticalStockCount()
                                    </span>
                                    <span>Productos críticos</span>
                                </div>
                            </div>
                            <div class="col-auto">
                                <i class="bi bi-exclamation-triangle fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-info shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs fw-bold text-info text-uppercase mb-1">
                                    Categorías Activas
                                </div>
                                <div class="row no-gutters align-items-center">
                                    <div class="col-auto">
                                        <div class="h5 mb-0 mr-3 fw-bold text-gray-800">
                                            @stats.TotalCategories
                                        </div>
                                    </div>
                                    <div class="col">
                                        <div class="progress progress-sm mr-2">
                                            <div class="progress-bar bg-info" 
                                                 style="width: @GetCategoryPercentage()%"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-2 mb-0 text-muted text-xs">
                                    <span>@stats.Categories.Count(c => (c.InventoryItems?.Count ?? 0) > 0) con productos</span>
                                </div>
                            </div>
                            <div class="col-auto">
                                <i class="bi bi-tags fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Productos Recientes y Resumen -->
        <div class="row">
            <!-- Productos Recientes -->
            <div class="col-xl-4 col-lg-5">
                <div class="card shadow mb-4">
                    <div class="card-header py-3 d-flex justify-content-between align-items-center">
                        <h6 class="m-0 fw-bold text-primary">
                            <i class="bi bi-clock-history me-1"></i>Productos Recientes
                        </h6>
                        <a href="/inventory" class="btn btn-sm btn-outline-primary">
                            Ver Todo
                        </a>
                    </div>
                    <div class="card-body p-0">
                        <div class="list-group list-group-flush">
                            @if (stats.RecentItems.Any())
                            {
                                @foreach (var item in stats.RecentItems)
                                {
                                    <a href="/inventory/detail/@item.Id" 
                                       class="list-group-item list-group-item-action border-0">
                                        <div class="d-flex w-100 justify-content-between align-items-start">
                                            <div class="me-3">
                                                <h6 class="mb-1 text-dark">@item.Name</h6>
                                                <div class="d-flex align-items-center">
                                                    <small class="text-muted me-2">@item.Category?.Name</small>
                                                    <span class="badge @GetQuantityBadgeClass(item.Quantity)">
                                                        @item.Quantity unidades
                                                    </span>
                                                </div>
                                            </div>
                                            <div class="text-end">
                                                <small class="text-muted d-block">@item.CreatedAt.ToString("dd/MM")</small>
                                                <small class="fw-bold text-dark">@item.Price.ToString("C")</small>
                                            </div>
                                        </div>
                                    </a>
                                }
                            }
                            else
                            {
                                <div class="text-center py-4">
                                    <i class="bi bi-inbox text-muted fs-1"></i>
                                    <p class="text-muted mt-2 mb-0">No hay productos recientes</p>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <!-- Resumen por Categoría -->
            <div class="col-xl-8 col-lg-7">
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 fw-bold text-primary">
                            <i class="bi bi-grid me-1"></i>Resumen por Categoría
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            @{
                                var categoriesWithProducts = stats.Categories
                                    .Where(c => (c.InventoryItems?.Count ?? 0) > 0)
                                    .OrderByDescending(c => c.InventoryItems?.Count ?? 0)
                                    .ToList();
                            }
                            
                            @if (categoriesWithProducts.Any())
                            {
                                @foreach (var category in categoriesWithProducts)
                                {
                                    var itemCount = category.InventoryItems?.Count ?? 0;
                                    var categoryItems = category.InventoryItems?.ToList() ?? new List<InventoryItem>();
                                    var totalQuantity = categoryItems.Sum(i => i.Quantity);
                                    var totalValue = categoryItems.Sum(i => i.Quantity * i.Price);
                                    var lowStockCount = categoryItems.Count(i => i.Quantity < 10);
                                    
                                    <div class="col-md-6 mb-4">
                                        <div class="card h-100 border-start-primary">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-start">
                                                    <div>
                                                        <h6 class="card-title mb-1">
                                                            <i class="bi bi-tag me-1"></i>@category.Name
                                                        </h6>
                                                        <p class="text-muted small mb-2">@itemCount productos</p>
                                                    </div>
                                                    <span class="badge bg-primary">@totalQuantity uds</span>
                                                </div>
                                                
                                                <div class="mt-3">
                                                    <div class="d-flex justify-content-between mb-1">
                                                        <span class="small">Valor total:</span>
                                                        <span class="fw-bold">@totalValue.ToString("C")</span>
                                                    </div>
                                                    <div class="d-flex justify-content-between mb-1">
                                                        <span class="small">Bajo stock:</span>
                                                        <span class="badge @(lowStockCount > 0 ? "bg-warning" : "bg-success")">
                                                            @lowStockCount
                                                        </span>
                                                    </div>
                                                    <div class="progress mt-2" style="height: 5px;">
                                                        @{
                                                            var totalItemsAllCategories = categoriesWithProducts
                                                                .Sum(c => c.InventoryItems?.Count ?? 0);
                                                            var percentage = totalItemsAllCategories > 0 
                                                                ? (itemCount * 100.0 / totalItemsAllCategories) 
                                                                : 0;
                                                        }
                                                        <div class="progress-bar bg-primary" 
                                                             style="width: @Math.Min(100, percentage)%">
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div class="mt-3">
                                                    <a href="/inventory" 
                                                       class="btn btn-sm btn-outline-primary w-100">
                                                        <i class="bi bi-arrow-right me-1"></i>Ver Productos
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }
                            }
                            else
                            {
                                <div class="col-12 text-center py-4">
                                    <i class="bi bi-tags display-1 text-muted"></i>
                                    <h5 class="mt-3">No hay categorías con productos</h5>
                                    <p class="text-muted">Agrega productos para ver el resumen por categoría.</p>
                                    <a href="/inventory/create" class="btn btn-primary">
                                        <i class="bi bi-plus-circle me-1"></i>Agregar Primer Producto
                                    </a>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabla de Productos Críticos -->
        <div class="row mt-4">
            <div class="col-lg-12">
                <div class="card shadow mb-4">
                    <div class="card-header py-3 d-flex justify-content-between align-items-center">
                        <h6 class="m-0 fw-bold text-warning">
                            <i class="bi bi-exclamation-triangle me-1"></i>Productos con Bajo Stock
                        </h6>
                        <div>
                            <span class="badge bg-danger me-2">@GetOutOfStockCount() Agotados</span>
                            <span class="badge bg-warning">@GetLowStockCount() Bajo Stock</span>
                        </div>
                    </div>
                    <div class="card-body">
                        @if (lowStockItems.Any())
                        {
                            <div class="table-responsive">
                                <table class="table table-bordered table-hover">
                                    <thead class="table-warning">
                                        <tr>
                                            <th>Producto</th>
                                            <th>Categoría</th>
                                            <th class="text-center">Stock Actual</th>
                                            <th class="text-center">Stock Mínimo</th>
                                            <th class="text-center">Estado</th>
                                            <th class="text-center">Última Actualización</th>
                                            <th class="text-center">Acción</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var item in lowStockItems)
                                        {
                                            <tr>
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                        <div class="symbol symbol-40px me-3">
                                                            <div class="symbol-label bg-light-warning">
                                                                <i class="bi bi-box text-warning"></i>
                                                            </div>
                                                        </div>
                                                        <div>
                                                            <a href="/inventory/detail/@item.Id" class="text-dark fw-bold">
                                                                @item.Name
                                                            </a>
                                                            @if (!string.IsNullOrEmpty(item.Description))
                                                            {
                                                                <p class="text-muted mb-0 small">@GetShortDescription(item.Description, 50)</p>
                                                            }
                                                        </div>
                                                    </div>
                                                </td>
                                                <td>
                                                    <span class="badge bg-info">@item.Category?.Name</span>
                                                </td>
                                                <td class="text-center">
                                                    <span class="badge @GetStockBadgeClass(item.Quantity)">
                                                        @item.Quantity
                                                    </span>
                                                </td>
                                                <td class="text-center">
                                                    <span class="badge bg-secondary">10</span>
                                                </td>
                                                <td class="text-center">
                                                    @GetStockStatusBadge(item.Quantity)
                                                </td>
                                                <td class="text-center">
                                                    @if (item.UpdatedAt.HasValue)
                                                    {
                                                        <small class="text-muted">@item.UpdatedAt.Value.ToString("dd/MM/yyyy")</small>
                                                    }
                                                    else
                                                    {
                                                        <small class="text-muted">Nunca</small>
                                                    }
                                                </td>
                                                <td class="text-center">
                                                    <div class="btn-group" role="group">
                                                        <a href="/inventory/edit/@item.Id" 
                                                           class="btn btn-sm btn-warning" title="Reponer stock">
                                                            <i class="bi bi-cart-plus"></i>
                                                        </a>
                                                        <a href="/inventory/detail/@item.Id" 
                                                           class="btn btn-sm btn-outline-info" title="Ver detalles">
                                                            <i class="bi bi-eye"></i>
                                                        </a>
                                                    </div>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                    <tfoot class="table-light">
                                        <tr>
                                            <td colspan="7" class="text-muted small">
                                                <i class="bi bi-info-circle me-1"></i>
                                                Mostrando @lowStockItems.Count productos con menos de 10 unidades en stock.
                                                Se recomienda reponer los productos marcados como <span class="badge bg-danger">Crítico</span>.
                                            </td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        }
                        else
                        {
                            <div class="text-center py-5">
                                <i class="bi bi-check-circle display-1 text-success"></i>
                                <h5 class="mt-3">¡Excelente!</h5>
                                <p class="text-muted">No hay productos con bajo stock.</p>
                                <a href="/inventory" class="btn btn-primary mt-2">
                                    <i class="bi bi-box-seam me-1"></i>Ver Inventario Completo
                                </a>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private bool loading = true;
    private DashboardStats stats = new();
    private List<InventoryItem> lowStockItems = new();
    private string dateRange = "month";
    
    protected override async Task OnInitializedAsync()
    {
        await LoadDashboardData();
    }
    
    private async Task LoadDashboardData()
    {
        loading = true;
        StateHasChanged();
        
        try
        {
            // Cargar estadísticas
            stats.TotalItems = await Context.InventoryItems
                .SumAsync(i => (int?)i.Quantity) ?? 0;
            
            stats.LowStockItems = await Context.InventoryItems
                .Where(i => i.Quantity < 10)
                .CountAsync();
            
            stats.TotalCategories = await Context.Categories.CountAsync();
            
            var items = await Context.InventoryItems
                .Select(i => new { i.Quantity, i.Price })
                .ToListAsync();
            stats.TotalValue = items.Sum(i => i.Quantity * i.Price);
            
            stats.RecentItems = await Context.InventoryItems
                .Include(i => i.Category)
                .OrderByDescending(i => i.CreatedAt)
                .Take(5)
                .ToListAsync();
            
            stats.Categories = await Context.Categories
                .Include(c => c.InventoryItems)
                .ToListAsync();
            
            // Cargar productos con bajo stock
            lowStockItems = await Context.InventoryItems
                .Include(i => i.Category)
                .Where(i => i.Quantity < 10)
                .OrderBy(i => i.Quantity)
                .ToListAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error cargando dashboard: {ex.Message}");
        }
        finally
        {
            loading = false;
            StateHasChanged();
        }
    }
    
    private async Task SetDateRange(string range)
    {
        dateRange = range;
        await LoadDashboardData();
    }
    
    private string GetQuantityBadgeClass(int quantity)
    {
        return quantity switch
        {
            0 => "bg-danger",
            < 10 => "bg-warning",
            _ => "bg-success"
        };
    }
    
    private string GetStockBadgeClass(int quantity)
    {
        return quantity switch
        {
            0 => "bg-danger text-white",
            < 5 => "bg-danger text-white",
            < 10 => "bg-warning text-dark",
            _ => "bg-success text-white"
        };
    }
    
    private MarkupString GetStockStatusBadge(int quantity)
    {
        var (text, color) = quantity switch
        {
            0 => ("AGOTADO", "danger"),
            < 5 => ("CRÍTICO", "danger"),
            < 10 => ("BAJO STOCK", "warning"),
            < 20 => ("STOCK MEDIO", "info"),
            _ => ("STOCK ALTO", "success")
        };
        
        return new MarkupString($"<span class='badge bg-{color}'>{text}</span>");
    }
    
    private double GetCategoryPercentage()
    {
        if (stats.TotalCategories == 0) return 0;
        return Math.Min(100, (stats.TotalCategories / 10.0) * 100);
    }
    
    private int GetCriticalStockCount()
    {
        return lowStockItems.Count(i => i.Quantity < 5);
    }
    
    private int GetLowStockCount()
    {
        return lowStockItems.Count(i => i.Quantity >= 5 && i.Quantity < 10);
    }
    
    private int GetOutOfStockCount()
    {
        return lowStockItems.Count(i => i.Quantity == 0);
    }
    
    private string GetShortDescription(string description, int maxLength = 50)
    {
        if (string.IsNullOrEmpty(description))
            return "";
        
        return description.Length > maxLength 
            ? description.Substring(0, maxLength) + "..." 
            : description;
    }
}